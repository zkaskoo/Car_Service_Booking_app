# System Architecture

## High-Level Architecture

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              CLIENT LAYER                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                         Next.js 15 (Vercel)                          │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌────────────┐  │   │
│  │  │   Landing   │  │    Auth     │  │  Dashboard  │  │   Admin    │  │   │
│  │  │    Pages    │  │   Pages     │  │    Pages    │  │   Panel    │  │   │
│  │  └─────────────┘  └─────────────┘  └─────────────┘  └────────────┘  │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                        │
│                                    │ HTTPS/REST                             │
│                                    ▼                                        │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│                              API LAYER                                       │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                      Laravel 11 (API Server)                         │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌────────────┐  │   │
│  │  │    Auth     │  │  Bookings   │  │  Services   │  │   Users    │  │   │
│  │  │  Sanctum    │  │    API      │  │    API      │  │    API     │  │   │
│  │  └─────────────┘  └─────────────┘  └─────────────┘  └────────────┘  │   │
│  │                                                                      │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐                  │   │
│  │  │   Actions   │  │  Services   │  │   Events    │                  │   │
│  │  │  (Logic)    │  │  (Business) │  │  (Dispatch) │                  │   │
│  │  └─────────────┘  └─────────────┘  └─────────────┘                  │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│              │                    │                    │                    │
│              ▼                    ▼                    ▼                    │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│                            DATA LAYER                                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────────────┐     │
│  │                 │  │                 │  │                         │     │
│  │   PostgreSQL    │  │      Redis      │  │     Email Service       │     │
│  │    Database     │  │  Cache/Queue    │  │   (Mailtrap/SES)        │     │
│  │                 │  │                 │  │                         │     │
│  └─────────────────┘  └─────────────────┘  └─────────────────────────┘     │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## Component Architecture

### Frontend Components

```
┌─────────────────────────────────────────────────────────────────────┐
│                        NEXT.JS APP ROUTER                            │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  Route Groups:                                                      │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐              │
│  │  (marketing) │  │    (auth)    │  │  (dashboard) │              │
│  │  - /         │  │  - /login    │  │  - /dashboard│              │
│  │  - /services │  │  - /register │  │  - /bookings │              │
│  │  - /about    │  │  - /verify   │  │  - /vehicles │              │
│  │  - /contact  │  │  - /forgot   │  │  - /profile  │              │
│  └──────────────┘  └──────────────┘  └──────────────┘              │
│                                                                     │
│  Shared:                                                            │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │                      Components Library                       │  │
│  │  ┌────────┐ ┌────────┐ ┌────────┐ ┌────────┐ ┌────────────┐  │  │
│  │  │ Button │ │  Card  │ │ Input  │ │ Modal  │ │DatePicker  │  │  │
│  │  └────────┘ └────────┘ └────────┘ └────────┘ └────────────┘  │  │
│  └──────────────────────────────────────────────────────────────┘  │
│                                                                     │
│  State Management:                                                  │
│  ┌────────────────────┐  ┌────────────────────┐                    │
│  │  AuthContext       │  │  TanStack Query    │                    │
│  │  (User Session)    │  │  (Server State)    │                    │
│  └────────────────────┘  └────────────────────┘                    │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

### Backend Architecture

```
┌─────────────────────────────────────────────────────────────────────┐
│                      LARAVEL APPLICATION                             │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  HTTP Layer:                                                        │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │                       API Routes (v1)                         │  │
│  │  /api/v1/auth/*  │  /api/v1/bookings/*  │  /api/v1/admin/*   │  │
│  └──────────────────────────────────────────────────────────────┘  │
│                              │                                      │
│                              ▼                                      │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │                       Middleware                              │  │
│  │  auth:sanctum │ verified │ throttle │ role:admin             │  │
│  └──────────────────────────────────────────────────────────────┘  │
│                              │                                      │
│                              ▼                                      │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │                       Controllers                             │  │
│  │  AuthController │ BookingController │ VehicleController      │  │
│  └──────────────────────────────────────────────────────────────┘  │
│                              │                                      │
│                              ▼                                      │
│  Business Layer:                                                    │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │                         Actions                               │  │
│  │  CreateBookingAction │ RegisterUserAction │ CancelBooking    │  │
│  └──────────────────────────────────────────────────────────────┘  │
│                              │                                      │
│                              ▼                                      │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │                        Services                               │  │
│  │  BookingAvailabilityService │ PriceCalculatorService         │  │
│  └──────────────────────────────────────────────────────────────┘  │
│                              │                                      │
│                              ▼                                      │
│  Data Layer:                                                        │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │                        Models                                 │  │
│  │  User │ Booking │ Vehicle │ Service │ ServiceCategory        │  │
│  └──────────────────────────────────────────────────────────────┘  │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

---

## Authentication Flow

```
┌────────┐                    ┌────────┐                    ┌────────┐
│Frontend│                    │ Laravel│                    │Database│
└───┬────┘                    └───┬────┘                    └───┬────┘
    │                             │                             │
    │  POST /api/v1/auth/register │                             │
    │────────────────────────────>│                             │
    │                             │  Create User                │
    │                             │────────────────────────────>│
    │                             │                             │
    │                             │  Generate Verification Token│
    │                             │────────────────────────────>│
    │                             │                             │
    │                             │  Dispatch Email Job         │
    │                             │──────────┐                  │
    │                             │          │                  │
    │  Return Token + User        │          │                  │
    │<────────────────────────────│          │                  │
    │                             │          │                  │
    │                             │          ▼                  │
    │                             │    ┌──────────┐             │
    │                             │    │  Queue   │             │
    │                             │    │  Worker  │             │
    │                             │    └────┬─────┘             │
    │                             │         │                   │
    │                             │         ▼                   │
    │                             │    ┌──────────┐             │
    │                             │    │  Email   │             │
    │                             │    │ Service  │             │
    │                             │    └──────────┘             │
    │                             │                             │
    │  POST /api/v1/auth/email/verify                           │
    │────────────────────────────>│                             │
    │                             │  Verify Token               │
    │                             │────────────────────────────>│
    │                             │                             │
    │                             │  Mark Email Verified        │
    │                             │────────────────────────────>│
    │                             │                             │
    │  Return Success             │                             │
    │<────────────────────────────│                             │
    │                             │                             │
```

---

## Booking Flow

```
┌─────────────────────────────────────────────────────────────────────┐
│                        BOOKING WIZARD                                │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  Step 1              Step 2              Step 3              Step 4 │
│  ┌─────────┐        ┌─────────┐        ┌─────────┐        ┌───────┐│
│  │ Select  │───────>│ Select  │───────>│ Select  │───────>│Confirm││
│  │ Vehicle │        │Services │        │Date/Time│        │& Pay  ││
│  └─────────┘        └─────────┘        └─────────┘        └───────┘│
│       │                  │                  │                  │    │
│       ▼                  ▼                  ▼                  ▼    │
│  ┌─────────┐        ┌─────────┐        ┌─────────┐        ┌───────┐│
│  │   GET   │        │   GET   │        │   GET   │        │ POST  ││
│  │/vehicles│        │/services│        │/avail-  │        │/book- ││
│  │         │        │         │        │ ability │        │ings   ││
│  └─────────┘        └─────────┘        └─────────┘        └───────┘│
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────┐
│                     BACKEND PROCESSING                               │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  ┌────────────────────────────────────────────────────────────┐    │
│  │                  CreateBookingAction                        │    │
│  │  1. Validate vehicle ownership                              │    │
│  │  2. Validate services exist and are active                  │    │
│  │  3. Check availability (BookingAvailabilityService)         │    │
│  │  4. Calculate pricing (PriceCalculatorService)              │    │
│  │  5. Assign service bay                                      │    │
│  │  6. Generate booking reference                              │    │
│  │  7. Create booking record                                   │    │
│  │  8. Attach services (pivot table)                           │    │
│  │  9. Record status history                                   │    │
│  │  10. Dispatch confirmation email                            │    │
│  └────────────────────────────────────────────────────────────┘    │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

---

## Data Flow

```
┌─────────────────────────────────────────────────────────────────────┐
│                         REQUEST FLOW                                 │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  Browser ──> Next.js ──> API Route ──> Laravel ──> Database         │
│     │            │           │            │           │             │
│     │            │           │            │           │             │
│  ┌──┴──┐     ┌───┴───┐   ┌───┴───┐   ┌────┴───┐   ┌───┴───┐        │
│  │React│     │Server │   │  API  │   │Actions │   │Eloquent│        │
│  │Comp.│     │Render │   │ Call  │   │  +     │   │Models  │        │
│  └─────┘     └───────┘   └───────┘   │Services│   └───────┘        │
│                                      └────────┘                     │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

---

## Security Architecture

```
┌─────────────────────────────────────────────────────────────────────┐
│                      SECURITY LAYERS                                 │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  Layer 1: Network                                                   │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │  Cloudflare (DDoS Protection, WAF, SSL/TLS)                  │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                              │                                      │
│  Layer 2: Application                                               │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌─────────────┐  │   │
│  │  │  CORS    │  │  Rate    │  │  CSRF    │  │  Input      │  │   │
│  │  │  Policy  │  │ Limiting │  │Protection│  │ Validation  │  │   │
│  │  └──────────┘  └──────────┘  └──────────┘  └─────────────┘  │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                              │                                      │
│  Layer 3: Authentication                                            │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │  ┌──────────────┐  ┌──────────────┐  ┌───────────────────┐  │   │
│  │  │   Sanctum    │  │    Email     │  │   Role-Based      │  │   │
│  │  │   Tokens     │  │ Verification │  │ Access Control    │  │   │
│  │  └──────────────┘  └──────────────┘  └───────────────────┘  │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                              │                                      │
│  Layer 4: Data                                                      │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │  ┌──────────────┐  ┌──────────────┐  ┌───────────────────┐  │   │
│  │  │  Encrypted   │  │  Prepared    │  │  Data            │   │   │
│  │  │  Passwords   │  │  Statements  │  │  Sanitization    │   │   │
│  │  └──────────────┘  └──────────────┘  └───────────────────┘  │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

---

**Related Documents:**
- [[02-Tech-Stack]]
- [[04-Database-Schema]]
- [[06-Authentication-Flow]]
